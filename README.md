# Auto-check-EGE-math

Система автоматической проверки решений задач ЕГЭ по математике с использованием моделей искусственного интеллекта.

## Описание проекта

**Auto-check-EGE-math** — это комплексная система для автоматической оценки решений задач Единого государственного экзамена (ЕГЭ) по математике. Система использует современные модели машинного обучения через OpenRouter API для анализа изображений с решениями студентов и выставления оценок в соответствии с критериями ЕГЭ.

### Основные возможности

- **Автоматическая оценка решений**: Анализ изображений с решениями задач ЕГЭ по математике
- **Поддержка различных типов задач**: Задачи 13-19 (тригонометрия, стереометрия, логарифмы, планиметрия, финансовая математика, параметры, теория чисел)
- **Множественные модели ИИ**: Поддержка reasoning и non-reasoning моделей через OpenRouter API
- **Бенчмаркинг**: Система для тестирования производительности различных моделей
- **Веб-интерфейс**: FastAPI backend с возможностью интеграции фронтенда
- **Анализ стоимости**: Расчет затрат на использование различных моделей

### Поддерживаемые типы задач

| Номер задачи | Описание | Максимальный балл |
|--------------|----------|-------------------|
| 13 | Тригонометрические уравнения | 2 |
| 14 | Стереометрическая задача | 3 |
| 15 | Логарифмические неравенства | 2 |
| 16 | Планиметрическая задача | 3 |
| 17 | Финансовая математика | 3 |
| 18 | Задача с параметром | 4 |
| 19 | Задача по теории чисел | 4 |

## Архитектура системы

Проект состоит из следующих основных компонентов:

### Backend (FastAPI)
- **API для оценки решений**: Основной endpoint для загрузки и оценки решений
- **Управление моделями**: Получение списка доступных моделей и их характеристик
- **Интеграция с OpenRouter**: Клиент для работы с различными моделями ИИ
- **Обработка изображений**: Утилиты для подготовки изображений к анализу
- **Генерация промптов**: Специализированные промпты для разных типов задач

### Frontend (React + TypeScript)
- **Веб-интерфейс**: Интерфейс для загрузки решений и просмотра результатов
- **Современный стек**: React 19, TypeScript, Vite
- **Responsive дизайн**: Адаптивный интерфейс для различных устройств

### Система бенчмаркинга
- **Тестирование моделей**: Автоматическое тестирование различных моделей ИИ
- **Анализ результатов**: Подробная статистика производительности
- **Датасет**: Коллекция решений с эталонными оценками
- **Метрики качества**: Точность, precision, recall, F1-score

## Технологический стек

### Backend
- **Python 3.8+**
- **FastAPI** - современный веб-фреймворк для API
- **OpenRouter API** - доступ к различным моделям ИИ
- **Pillow** - обработка изображений
- **Pydantic** - валидация данных
- **httpx** - асинхронные HTTP-запросы

### Frontend
- **React 19** - библиотека для создания пользовательских интерфейсов
- **TypeScript** - типизированный JavaScript
- **Vite** - быстрый инструмент сборки
- **Axios** - HTTP-клиент для API запросов

### Бенчмаркинг и данные
- **HuggingFace Datasets** - работа с датасетами
- **NumPy** - численные вычисления
- **Pandas** - анализ данных
- **JSON** - хранение метаданных и результатов

## Быстрый старт

### Предварительные требования

1. **Python 3.8+**
2. **Node.js 16+** (для фронтенда)
3. **OpenRouter API ключ** - получите на [openrouter.ai](https://openrouter.ai)

### Установка и запуск

#### 1. Клонирование репозитория
```bash
git clone https://github.com/Karifannaa/Auto-check-EGE-math.git
cd Auto-check-EGE-math
```

#### 2. Настройка backend
```bash
cd backend

# Создание виртуального окружения
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate

# Установка зависимостей
pip install -r requirements.txt

# Настройка переменных окружения
cp .env.example .env
# Отредактируйте .env файл, добавив ваш OpenRouter API ключ
```

#### 3. Запуск backend
```bash
uvicorn app.main:app --reload
```

Backend будет доступен по адресу: http://localhost:8000

#### 4. Настройка frontend (опционально)
```bash
cd ../frontend

# Установка зависимостей
npm install

# Запуск в режиме разработки
npm run dev
```

Frontend будет доступен по адресу: http://localhost:5173

## API Endpoints

### Основные endpoints

#### Оценка решений
- `POST /api/v1/solutions/evaluate` - Оценить решение задачи

**Параметры:**
- `task_type` - тип задачи (task_13, task_14, и т.д.)
- `model_id` - идентификатор модели
- `student_solution_image` - изображение с решением студента
- `correct_solution_image` - изображение с правильным решением (опционально)
- `temperature` - температура модели (по умолчанию 0.7)
- `max_tokens` - максимальное количество токенов (по умолчанию 10000)

#### Управление моделями
- `GET /api/v1/models/available` - Получить список доступных моделей
- `GET /api/v1/models/task-types` - Получить список типов задач
- `GET /api/v1/models/credits` - Получить информацию о кредитах аккаунта
- `GET /api/v1/models/cost-estimate/{model_id}` - Оценка стоимости использования модели

### Веб-интерфейс
- `GET /` - Главная страница с интерфейсом для оценки решений
- `GET /batch` - Интерфейс для пакетной обработки

## Структура проекта

```
Auto-check-EGE-math/
├── backend/                          # Backend приложение
│   ├── app/
│   │   ├── api/                      # API клиенты
│   │   │   └── openrouter_client.py  # Клиент OpenRouter
│   │   ├── core/                     # Основная конфигурация
│   │   │   └── config.py             # Настройки приложения
│   │   ├── models/                   # Модели данных
│   │   │   └── solution.py           # Модели для решений
│   │   ├── routers/                  # API маршруты
│   │   │   ├── solutions.py          # Маршруты для решений
│   │   │   ├── models.py             # Маршруты для моделей
│   │   │   └── web.py                # Веб-интерфейс
│   │   ├── utils/                    # Утилиты
│   │   │   ├── image_utils.py        # Обработка изображений
│   │   │   ├── prompt_utils.py       # Генерация промптов
│   │   │   ├── cost_calculator.py    # Расчет стоимости
│   │   │   └── score_extractor.py    # Извлечение оценок
│   │   ├── static/                   # Статические файлы
│   │   ├── templates/                # HTML шаблоны
│   │   └── main.py                   # Точка входа
│   ├── tests/                        # Тесты
│   ├── requirements.txt              # Python зависимости
│   └── README.md                     # Документация backend
├── frontend/                         # Frontend приложение
│   ├── src/                          # Исходный код
│   ├── public/                       # Публичные файлы
│   ├── package.json                  # Node.js зависимости
│   └── README.md                     # Документация frontend
├── dataset_benchmark/                # Система бенчмаркинга
│   ├── benchmark_models.py           # Основной модуль бенчмаркинга
│   ├── run_full_benchmark.py         # Запуск полного бенчмарка
│   ├── run_task13_benchmark.py       # Бенчмарк для задачи 13
│   ├── analyze_existing_results.py   # Анализ результатов
│   ├── metadata.json                 # Метаданные датасета
│   ├── benchmark_results/            # Результаты бенчмарков
│   └── [13-19]/                      # Папки с задачами по типам
├── dataset_benchmark_hf/             # HuggingFace датасет
├── fipi_examples_of_estimation/      # Примеры оценивания ФИПИ
└── README.md                         # Основная документация
```

## Бенчмаркинг моделей

Система включает в себя мощный инструмент для тестирования производительности различных моделей ИИ на датасете решений ЕГЭ.

### Предварительные требования для бенчмаркинга

1. **Настроенный backend** с OpenRouter API ключом
2. **Датасет** - автоматически загружается при первом запуске
3. **Достаточный баланс** на OpenRouter аккаунте для тестирования моделей

### Доступные модели для тестирования

#### Reasoning модели (с поддержкой мышления)
- `moonshotai/kimi-vl-a3b-thinking:free` - Бесплатная модель Kimi с визуальными возможностями
- `google/gemini-2.5-flash-preview:thinking` - Gemini с режимом мышления
- `google/gemini-2.0-flash-exp` - Экспериментальная версия Gemini

#### Non-reasoning модели
- `qwen/qwen2.5-vl-32b-instruct:free` - Бесплатная модель Qwen с визуальными возможностями
- `gpt-4o` - GPT-4 Omni от OpenAI
- `gpt-4o-mini` - Облегченная версия GPT-4 Omni

### Запуск бенчмарков

#### 1. Полный бенчмарк всех задач

```bash
cd dataset_benchmark

# Запуск с бесплатными моделями (рекомендуется для начала)
python run_full_benchmark.py

# Запуск с конкретными моделями
python run_full_benchmark.py --models "moonshotai/kimi-vl-a3b-thinking:free" "google/gemini-2.0-flash-exp"

# Ограничение количества примеров для тестирования
python run_full_benchmark.py --max-examples 5
```

#### 2. Бенчмарк конкретной задачи (например, задача 13)

```bash
# Тестирование только задачи 13
python run_task13_benchmark.py

# С конкретными параметрами
python run_task13_benchmark.py --models "google/gemini-2.0-flash-exp" --max-examples 10
```

#### 3. Бенчмарк с использованием эталонных решений

```bash
# Запуск бенчмарка с эталонными решениями для сравнения
python benchmark_models.py --task-id 13 --models "google/gemini-2.0-flash-exp" --use-true-solution
```

### Параметры бенчмаркинга

#### Основные параметры

- `--models` - Список моделей для тестирования
- `--max-examples` - Максимальное количество примеров на задачу
- `--task-id` - Конкретная задача для тестирования (13-19)
- `--use-true-solution` - Использовать эталонные решения для сравнения
- `--prompt-variant` - Вариант промпта (basic, detailed, with_solution)
- `--temperature` - Температура модели (по умолчанию 0.7)

#### Примеры команд

```bash
# Быстрое тестирование с ограниченным количеством примеров
python run_full_benchmark.py --max-examples 3

# Тестирование конкретной модели на всех задачах
python run_full_benchmark.py --models "moonshotai/kimi-vl-a3b-thinking:free"

# Детальное тестирование задачи 13 с эталонными решениями
python benchmark_models.py --task-id 13 --use-true-solution --prompt-variant detailed

# Тестирование нескольких моделей с разными температурами
python benchmark_models.py --models "google/gemini-2.0-flash-exp" "gpt-4o-mini" --temperature 0.3
```

### Интерпретация результатов

#### Файлы результатов

После завершения бенчмарка создаются следующие файлы:

1. **Основные результаты**: `benchmark_results/benchmark_[model]_[timestamp].json`
2. **Анализ**: `benchmark_results/benchmark_[model]_[timestamp]_analysis.json`
3. **Таблицы метрик**: `benchmark_results/benchmark_[model]_[timestamp]_metrics_table.tex`

#### Ключевые метрики

- **Accuracy (Точность)**: Процент правильно оцененных решений
- **Quality Score**: Качественная оценка на основе близости к эталонной оценке
- **Precision/Recall/F1**: Метрики для каждого балла отдельно
- **Average Score Distance**: Среднее отклонение от правильной оценки
- **Confusion Matrix**: Матрица ошибок для детального анализа

#### Пример вывода результатов

```
Benchmark Summary:
Total examples: 122
Total evaluations: 244
Total cost: $2.4567
Average quality score: 78.45%

Model Performance:

google/gemini-2.0-flash-exp:
  with_answer:
    Accuracy: 73.77%
    Quality score: 81.25%
    Avg. score distance: 0.43
    Macro precision: 75.20%
    Macro recall: 71.80%
    Macro F1: 73.45%
    Evaluations: 122
    Avg. evaluation time: 8.45s
    Total cost: $1.2345
```

### Анализ существующих результатов

```bash
# Анализ уже сохраненных результатов
python analyze_existing_results.py

# Сравнение результатов разных моделей
python analyze_existing_results.py --compare-models
```

### Устранение неполадок

#### Частые проблемы и решения

1. **Ошибка "Rate limit exceeded"**
   ```
   Решение: Система автоматически повторяет запросы с экспоненциальной задержкой.
   Если проблема сохраняется, уменьшите количество одновременных запросов или используйте модели с более высокими лимитами.
   ```

2. **Ошибка "OpenRouter API key not configured"**
   ```bash
   # Убедитесь, что API ключ настроен в backend/.env
   echo "OPENROUTER_API_KEY=your_key_here" >> backend/.env
   ```

3. **Ошибка "Dataset not found"**
   ```bash
   # Убедитесь, что датасет находится в правильной папке
   ls dataset_benchmark_hf/
   # Если датасет отсутствует, он будет загружен автоматически при первом запуске
   ```

4. **Недостаточно средств на аккаунте**
   ```
   Решение: Пополните баланс на OpenRouter или используйте бесплатные модели:
   - moonshotai/kimi-vl-a3b-thinking:free
   - qwen/qwen2.5-vl-32b-instruct:free
   ```

5. **Медленная работа бенчмарка**
   ```bash
   # Используйте ограничение количества примеров для быстрого тестирования
   python run_full_benchmark.py --max-examples 5

   # Или тестируйте только одну задачу
   python run_task13_benchmark.py --max-examples 10
   ```

### Рекомендации по использованию

1. **Начните с бесплатных моделей** для ознакомления с системой
2. **Используйте ограничение примеров** (`--max-examples`) для быстрого тестирования
3. **Сохраняйте результаты** для последующего анализа и сравнения
4. **Мониторьте расходы** через OpenRouter dashboard
5. **Анализируйте confusion matrix** для понимания типов ошибок модели

## Разработка и тестирование

### Запуск тестов

```bash
cd backend
pytest
```

### Структура тестов

- `backend/tests/` - Тесты для backend API
- Тесты покрывают основные функции OpenRouter клиента и обработки изображений

## Лицензия

Этот проект предоставляется для исследовательских целей.

## Контакты

- GitHub: [Karifannaa](https://github.com/Karifannaa)
- Email: ra.khrulev@gmail.com
